# Swimlane

### 应用场景

在测试中如何解决多人共用一套环境而产生的对于测试结果的影响？

微服务框架下服务个数多、调用链路较长，其中的一个服务或者链路上的某个节点出问题就会影响到全局整条链路。但是我们往往需要在该条链路上的多个服务配套测试，甚至是同时测试一个服务的多个版本的优劣。所以需要在生产环境中新增预发布环境，来方便测试与减少影响。

提供稳定环境并且多服务/多版本同时测试的需求可以通过泳道swimlane解决。

### 什么是泳道

对服务链按需求进行分组复制，并实现逻辑、物理的隔离，使得不同需求的服务链运行在相隔的物理机器上。

https://justinyangis.me/images/post/swimlane/swimlane.png

**并行测试**

根据测试的需要，部署不同分支的服务分组，多个泳道并行。 

**提供稳定的骨干链路**

保证整个的测试流程始终能正常运行

**错误隔离**

泳道内的服务发生异常 不会影响到其他泳道

### 泳道的实现

**服务的注册和发现**

当用户指定某泳道发布服务时，系统会为该服务的实例打上相应的泳道标记，服务注册和发现模块就能知道同一服务下不同实例的所属泳道。

https://static001.geekbang.org/infoq/5a/5a0a47425da0a008e191dff245203645.jpeg?x-oss-process=image/resize,p_80/auto-orient,1

**服务导流**

-   通过域名划分泳道：为各个泳道申请单独的域名。
-   通过header携带泳道信息：请求的header字段增加`swimlane=xxxx`标识请求要打到名为xxxx的泳道里，分流系统会根据该字段做分流。

对于前端的静态资源，也可以基于泳道名进行隔离。在资源编译和打包的时候，指定发布的泳道名，然后资源会上传到该泳道对应的静态服务器中。

多泳道发布是当今云时代自动化运维的必备工具。

### 泳道的特性

**原则：泳道可以调骨干，骨干不可以调泳道**

如果此泳道内没有部署被调用服务，流量会返回到骨干。但是如果泳道内存在被调用的节点，那么流量是一定不会fallback的。而且有一点需要注意，泳道之间是一定不会相互调用的。
